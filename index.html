<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Zappar Web‑AR • Fixed Placement Demo</title>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>

<!-- Zappar Universal‑AR Three.js v2.4.6 -->
<script src="https://libs.zappar.com/zappar-threejs/2.4.6/zappar-threejs.min.js"></script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;}
  #blocker{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    flex-direction:column;background:#000;color:#fff;font-family:sans-serif;gap:1rem}
  button{padding:0.8rem 1.4rem;font-size:1rem}
</style>
</head>
<body>

<div id="blocker">
  <p>Tap to start the camera</p>
  <button id="start-btn">Enter AR</button>
</div>

<script>
/* ---------- Renderer & WebGL context ---------- */
const renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

/* Give Zappar access to this GL context */
ZapparThree.glContextSet(renderer.getContext());                     // :contentReference[oaicite:0]{index=0}

/* ---------- Scene & Zappar camera ---------- */
const scene        = new THREE.Scene();
const zapparCamera = new ZapparThree.Camera();
scene.background   = zapparCamera.backgroundTexture;                 // :contentReference[oaicite:1]{index=1}
scene.add(zapparCamera);

/* ---------- Instant‑World tracker ---------- */
const tracker      = new ZapparThree.InstantWorldTracker();
const anchorGroup  = new ZapparThree.InstantWorldAnchorGroup(zapparCamera, tracker);
scene.add(anchorGroup);

/* ---------- Load your GLB ---------- */
new ZapparThree.GLTFLoader().load("PriestsHouse.glb", gltf => {
  anchorGroup.add(gltf.scene);
});

/* ---------- Placement control ---------- */
function placeOneMeterAhead(){
  tracker.setAnchorPoseFromCameraOffset(0, 0, -1);                   // 
}
let locked = false;

/* ---------- Permission + start flow ---------- */
document.getElementById("start-btn").addEventListener("click", () => {
  ZapparThree.permissionRequest()                                    // :contentReference[oaicite:3]{index=3}
    .then(granted => {
      if (!granted){ ZapparThree.permissionDeniedUI(); return; }
      zapparCamera.start();                                          // :contentReference[oaicite:4]{index=4}
      document.getElementById("blocker").style.display = "none";
      placeOneMeterAhead();
      animate();
    });
});

/* ---------- Main loop ---------- */
function animate(){
  requestAnimationFrame(animate);
  zapparCamera.updateFrame(renderer);
  if (!locked) placeOneMeterAhead();
  renderer.render(scene, zapparCamera);
}

/* Lock the placement on first user tap after AR starts */
window.addEventListener("click", () => { locked = true; }, {once:true});

/* ---------- Resize ---------- */
addEventListener("resize", () => {
  renderer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
