<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Zappar Web‑AR • Fixed‑Placement Demo (with logs)</title>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>

<!-- Zappar Universal‑AR Three.js v2.4.6 -->
<script src="https://libs.zappar.com/zappar-threejs/2.4.6/zappar-threejs.min.js"></script>

<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;}
  #blocker{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    flex-direction:column;background:#000;color:#fff;font-family:sans-serif;gap:1rem}
  button{padding:0.8rem 1.4rem;font-size:1rem}
</style>
</head>
<body>

<div id="blocker">
  <p>Tap to start the camera</p>
  <button id="start-btn">Enter AR</button>
</div>

<script>
/* =============== Utility: global error logger =============== */
window.addEventListener("error", e=>{
  console.error("[GLOBAL‑ERROR]", e.message, e.filename+":"+e.lineno);
});
window.addEventListener("unhandledrejection", e=>{
  console.error("[PROMISE‑REJECTION]", e.reason);
});

/* =============== Renderer & GL context =============== */
console.log("[BOOT] Creating WebGLRenderer…");
const renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

/* Give Zappar access to this WebGL context */
try{
  ZapparThree.glContextSet(renderer.getContext());
  console.log("✅ ZapparThree.glContextSet OK");
}catch(err){
  console.error("❌ glContextSet failed", err);
}

/* =============== Scene & Zappar camera =============== */
const scene        = new THREE.Scene();
const zapparCamera = new ZapparThree.Camera();
scene.background   = zapparCamera.backgroundTexture;
scene.add(zapparCamera);

/* =============== Instant‑world tracking =============== */
const tracker     = new ZapparThree.InstantWorldTracker();
const anchorGroup = new ZapparThree.InstantWorldAnchorGroup(zapparCamera, tracker);
scene.add(anchorGroup);

/* =============== Load GLB =============== */
console.log("[BOOT] Loading PriestsHouse.glb…");
new ZapparThree.GLTFLoader().load(
  "PriestsHouse.glb",
  gltf=>{
    console.log("✅ GLB loaded");
    anchorGroup.add(gltf.scene);
  },
  xhr=>{
    console.log(`[GLB] ${Math.round((xhr.loaded/xhr.total)*100)} %`);
  },
  err=>{
    console.error("❌ GLB load error", err);
  }
);

/* =============== Placement logic =============== */
function placeOneMeterAhead(){
  tracker.setAnchorPoseFromCameraOffset(0, 0, -1);
  console.log("[POSE] Anchor at 1 m forward");
}
let locked = false;

/* =============== Permission + start flow =============== */
const btn = document.getElementById("start-btn");
btn.addEventListener("click", () => {
  console.log("[UI] Enter AR clicked");
  ZapparThree.permissionRequestUI().then(granted=>{
    if (!granted){
      console.warn("❌ User denied permissions");
      ZapparThree.permissionDeniedUI();
      return;
    }
    console.log("✅ Permissions granted");
    console.log("[CAMERA] Starting Zappar camera…");
    zapparCamera.start().then(()=>{
      console.log("✅ Camera started");
      document.getElementById("blocker").style.display = "none";
      placeOneMeterAhead();
      animate();
    }).catch(err=>{
      console.error("❌ Camera start failed", err);
    });
  }).catch(err=>{
    console.error("❌ permissionRequestUI rejected", err);
  });
});

/* =============== Main loop =============== */
function animate(){
  requestAnimationFrame(animate);
  zapparCamera.updateFrame(renderer);
  if (!locked) placeOneMeterAhead();
  renderer.render(scene, zapparCamera);
}

/* Lock placement on first user tap after AR starts */
window.addEventListener("click", () => {
  if (!locked){
    locked = true;
    console.log("[POSE] Placement locked by user tap");
  }
},{once:true});

/* =============== Resize =============== */
addEventListener("resize", () => {
  renderer.setSize(innerWidth, innerHeight);
  console.log("[UI] Window resized");
});
</script>
</body>
</html>
