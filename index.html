<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cross‑platform Web AR with full placement control</title>

  <!-- 1.  Three.js (render engine) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>

  <!-- 2.  Zappar Universal AR for Three.js (works on iOS & Android) -->
  <script src="https://libs.zappar.com/zappar-threejs/2.4.6/zappar-threejs.min.js"></script>

  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;}
    #blocker{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
             flex-direction:column;background:#000;color:#fff;font-family:sans-serif;gap:1rem}
    button{padding:0.8rem 1.2rem;font-size:1rem}
  </style>
</head>
<body>

<!-- Camera‑permission overlay -->
<div id="blocker">
  <p>Tap to start the camera</p>
  <button id="start-btn">Enter AR</button>
</div>

<script>
/* ---------- Boilerplate: scene, renderer, camera ---------- */
const renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

const scene  = new THREE.Scene();
const camera = new THREE.PerspectiveCamera();

/* ---------- Zappar camera + pipeline ---------- */
const Z = window.ZapparThree;                 // UMD global
const zapparCamera = new Z.Camera();          // handles WebXR or ARKit under the hood
scene.add(zapparCamera);

/* ---------- Instant World Tracking (marker‑less) ---------- */
const tracker      = new Z.InstantWorldTracker();
const trackerGroup = new Z.InstantWorldAnchorGroup(zapparCamera, tracker);
scene.add(trackerGroup);

/* ---------- Load your GLB (replace "model.glb") ---------- */
const gltfLoader = new Z.GLTFLoader();        // patched version of three.js GLTFLoader
gltfLoader.load("PriestsHouse.glb", ({scene: glb})=>{
  trackerGroup.add(glb);                      // attach to anchor group
});

/* ---------- Placement logic: YOU are in charge ---------- */
// Example: place the anchor exactly 1 m in front of the camera, once, and lock it.
let hasPlaced = false;
function placeOneMeterAhead(){
  tracker.setAnchorPoseFromCameraOffset(0, 0, -1); // X,Y,Z in metres (‑Z is forward) :contentReference[oaicite:1]{index=1}
}

document.getElementById("start-btn").addEventListener("click", async ()=>{
  // Ask for camera permission – iOS & Android both hit this path.
  await Z.permissions.requestCameraPermissions();
  document.getElementById("blocker").style.display = "none";

  /* If you’d like the user to tap once on a surface instead
     of auto‑placing, comment out the next line and call
     placeOneMeterAhead() inside your own touch handler. */
  placeOneMeterAhead();

  animate();
});

/* ---------- Main frame loop ---------- */
function animate(){
  requestAnimationFrame(animate);

  // Update Zappar camera feed & pipeline
  zapparCamera.updateFrame(renderer);

  // OPTIONAL: keep updating pose until locked
  if(!hasPlaced){
    /* continuously try to keep the anchor 1 m ahead until we decide we’re happy */
    placeOneMeterAhead();
    // Example lock‑in if user taps the screen
    window.addEventListener("click", ()=>{ hasPlaced = true; }, {once:true});
  }

  renderer.render(scene, zapparCamera);
}

/* ---------- Handle window resize ---------- */
window.addEventListener("resize", ()=>{
  renderer.setSize(innerWidth,innerHeight);
});
</script>

</body>
</html>
